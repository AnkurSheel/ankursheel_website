
<!DOCTYPE html>
<html lang="en" class="min-h-screen">
<head>
    

<title>Ankur Sheel - How to publish email bounce notifications to an SQS queue</title>
<meta charset="utf-8"/>

<!-- Google Tag Manager -->

<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<meta name="description" content="In this post, I configure AWS to publish email bounce notifications to an SQS queue using terraform"/>
<link href="/assets/styles.css" rel="stylesheet"/>
<link href="/assets/code-styles/obsidian.min.css" rel="stylesheet"/>
<link rel="canonical" href="https://www.ankursheel.com/blog/handle-bounces-ses-terraform"/>

<meta itemProp="name" content="How to publish email bounce notifications to an SQS queue"/>
<meta itemProp="description" content="In this post, I configure AWS to publish email bounce notifications to an SQS queue using terraform"/>
    <meta itemProp="image" content="https://www.ankursheel.com/assets/images/social/handle-bounces-ses-terraform-facebook.png"/>
<meta property="og:url" content="https://www.ankursheel.com/blog/handle-bounces-ses-terraform"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="How to publish email bounce notifications to an SQS queue"/>
<meta property="og:description" content="In this post, I configure AWS to publish email bounce notifications to an SQS queue using terraform"/>
    <meta property="og:image" content="https://www.ankursheel.com/assets/images/social/handle-bounces-ses-terraform-facebook.png"/>
    <meta property="og:image:secure_url" content="https://www.ankursheel.com/assets/images/social/handle-bounces-ses-terraform-facebook.png"/>
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:site" content="ankur_sheel"/>
<meta name="twitter:creator" content="ankur_sheel"/>
<meta name="twitter:title" content="How to publish email bounce notifications to an SQS queue"/>
<meta name="twitter:description" content="In this post, I configure AWS to publish email bounce notifications to an SQS queue using terraform"/>
    <meta name="twitter:image" content="https://www.ankursheel.com/assets/images/social/handle-bounces-ses-terraform-twitter.png"/>
    <meta name="twitter:image:secure_url" content="https://www.ankursheel.com/assets/images/social/handle-bounces-ses-terraform-twitter.png"/>

</head>
<body class="font-sans font-normal leading-relaxed font-base text-gray-800 min-h-screen bg-gray-100">
<header class="sticky top-0 bg-white shadow-lg z-10">
    

<!-- https://www.section.io/engineering-education/creating-a-responsive-navigation-bar-using-tailwind-css-and-javascript/ -->

<nav>
    <div class="max-w-6xl mx-auto px-4">
        <div class="flex justify-between">
            <div class="flex space-x-7 items-center">
                <!-- Website Logo -->
                <div>
                    <a href="/" class="flex items-center py-4 px-2 ">
                        <span class="font-semibold text-gray-500 text-lg hover:text-green-500">
                            Ankur Sheel
                        </span
                        >
                    </a>
                </div>
                <ul class="hidden lg:flex items-center space-x-1">
                        <li class="py-4 px-2 text-gray-500 font-semibold hover:text-green-500 transition-all transform hover:scale-110">
                            <a href="/about">About</a>
                        </li>
                        <li class="py-4 px-2 text-gray-500 font-semibold hover:text-green-500 transition-all transform hover:scale-110">
                            <a href="/blog">All Posts</a>
                        </li>
                        <li class="py-4 px-2 text-gray-500 font-semibold hover:text-green-500 transition-all transform hover:scale-110">
                            <a href="/tags">All Tags</a>
                        </li>
                        <li class="py-4 px-2 text-gray-500 font-semibold hover:text-green-500 transition-all transform hover:scale-110">
                            <a href="/contact">Contact</a>
                        </li>
                        <li class="py-4 px-2 text-gray-500 font-semibold hover:text-green-500 transition-all transform hover:scale-110">
                            <a href="/cv">CV</a>
                        </li>
                        <li class="py-4 px-2 text-gray-500 font-semibold hover:text-green-500 transition-all transform hover:scale-110">
                            <a href="/impossible-list">Impossible List</a>
                        </li>
                </ul>
            </div>

            <ul class="hidden lg:flex items-center space-x-3">
                <li>
                    <a role="button" class="" target="_blank" rel="noopener noreferrer" href="/rss.xml" title="RSS">
                        <img class="h-8 mr-2 border-none" src="/assets/images/rss.svg" alt="RSS">
                    </a>
                </li>
                <li>
                    <a role="button" class="inline-flex items-center bg-green-400 text-white p-2 rounded-md text-2xl drop-shadow-lg hover:bg-green-800" target="_blank" rel="noopener noreferrer" href="https://www.buymeacoffee.com/ankursheel" title="Did you learn something or find this summary interesting?">
                        <img class="h-8 mr-2 border-none" src="/assets/images/bmc-logo.svg" alt="Buy Me A Coffee">
                        <p class="font-cookie">Buy me a book</p>
                    </a>
                </li>
            </ul>

            <div class="lg:hidden flex items-center">
                <button class="outline-none mobile-menu-button" aria-label="Mobile Menu">
                    <svg class="h-6 w-6 fill-current" viewBox="0 0 24 24">
                        <path fill-rule="evenodd"
                              d="M4 5h16a1 1 0 0 1 0 2H4a1 1 0 1 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2zm0 6h16a1 1 0 0 1 0 2H4a1 1 0 0 1 0-2z"/>
                    </svg>
                </button>
            </div>

        </div>
        <div class="hidden mobile-menu">
            <ul class="flex flex-col">
                    <li class="text-sm px-2 py-4 hover:bg-green-500 transition duration-300">
                        <a href="/about" class="block">About</a>
                    </li>
                    <li class="text-sm px-2 py-4 hover:bg-green-500 transition duration-300">
                        <a href="/blog" class="block">All Posts</a>
                    </li>
                    <li class="text-sm px-2 py-4 hover:bg-green-500 transition duration-300">
                        <a href="/tags" class="block">All Tags</a>
                    </li>
                    <li class="text-sm px-2 py-4 hover:bg-green-500 transition duration-300">
                        <a href="/contact" class="block">Contact</a>
                    </li>
                    <li class="text-sm px-2 py-4 hover:bg-green-500 transition duration-300">
                        <a href="/cv" class="block">CV</a>
                    </li>
                    <li class="text-sm px-2 py-4 hover:bg-green-500 transition duration-300">
                        <a href="/impossible-list" class="block">Impossible List</a>
                    </li>
            </ul>
        </div>
    </div>
</nav>

</header>
<main class="mx-auto max-w-prose p-8 prose prose-xl prose-purple">
    <h1 class="text-center">How to publish email bounce notifications to an SQS queue</h1>
    <div class="flex flex-col min-h-screen">
        <article>
            
<div class="prose-sm italic ">
    <div class="flex justify-evenly items-center">
        <i>Last Updated On: 29-Apr-2020</i>
        <i class="font-bold">
            Reading Time: 3 min
        </i>
    </div>

    <div class="flex flex-row flex-wrap gap-1 place-content-center">
            <div class="flex-initial border-2 border-black p-2 m-2 border rounded-xl">
                <a role="button" href="/tags/terraform" class="badge text-black bg-grey-light no-underline">terraform</a>
            </div>
            <div class="flex-initial border-2 border-black p-2 m-2 border rounded-xl">
                <a role="button" href="/tags/devops" class="badge text-black bg-grey-light no-underline">devops</a>
            </div>
            <div class="flex-initial border-2 border-black p-2 m-2 border rounded-xl">
                <a role="button" href="/tags/aws" class="badge text-black bg-grey-light no-underline">AWS</a>
            </div>
    </div>
</div>

<html><head></head><body><p>Recently, I had to work on a task to notify us in slack whenever an email sent through Amazon Simple Email Service(SES) bounced. <strong>Rohan Deshpande</strong> has a great <a href="https://aws.amazon.com/blogs/messaging-and-targeting/handling-bounces-and-complaints/">article which shows how to handle bounces and complaints</a>. Since this article leans heavily on his approach, I recommend reading that first.</p>
<p>Go on, I will wait.</p>
<p>Oh, Good, you are back. So you might be wondering that if Rohan has already written the article, why am I writing this and more importantly, why should you spend your precious time reading this?</p>
<p>Well, although his solution solves the problem, it requires me to use the AWS Management Console. However, I want to leverage <a href="https://www.terraform.io/">terraform</a> so that any changes I make can be easily deployed to all the environments.</p>
<h2 id="step-1-create-an-amazon-sqs-queue">Step 1: Create an Amazon SQS queue</h2>
<p>I will setup the SQS queue using <a href="https://www.terraform.io/docs/providers/aws/r/sqs_queue.html">Resource: aws_sqs_queue</a></p>
<pre><code class="language-hcl">resource "aws_sqs_queue" "ses_bounces_queue" {
  name                      = "ses_bounces_queue"
  message_retention_seconds = 1209600
  redrive_policy            = "{\"deadLetterTargetArn\":\"${aws_sqs_queue.ses_dead_letter_queue.arn}\",\"maxReceiveCount\":4}"
}

resource "aws_sqs_queue" "ses_dead_letter_queue" {
  name = "ses_dead_letter_queue"
}
</code></pre>
<ul>
<li>Set the human-readable name of the queue to <em>ses_bounces_queue</em> so that terraform does not assign a random name to our queue.</li>
<li>Set the number of seconds SQS retains the message to 14 days(1209600 seconds).</li>
<li>Set up our dead letter queue to handle messages that could not be handled to help debug and isolate problems. Read more about <a href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html">SQS Dead-Letter Queues</a>.</li>
</ul>
<h2 id="step-2-create-an-amazon-sns-topic_arn">Step 2: Create an Amazon SNS topic_arn</h2>
<p>I will set up the SNS topic using <a href="https://www.terraform.io/docs/providers/aws/r/sns_topic.html">Resource: aws_sns_topic</a></p>
<pre><code class="language-hcl">resource "aws_sns_topic" "ses_bounces_topic" {
  name     = "ses_bounces_topic"
}
</code></pre>
<ul>
<li>Set the human-readable name of the queue to <em>ses_bounces_topic</em> so that terraform does not assign a random name to our queue.</li>
</ul>
<h2 id="step-3-configure-the-amazon-sns-topic-to-publish-to-the-sqs-queue">Step 3: Configure the Amazon SNS topic to publish to the SQS queue</h2>
<p>I will use <a href="https://www.terraform.io/docs/providers/aws/r/sns_topic_subscription.html">Resource: aws_sns_topic_subscription</a> to automatically place the messages sent to the SNS topic in the SQS queue.</p>
<pre><code class="language-hcl">resource "aws_sns_topic_subscription" "ses_bounces_subscription" {
  topic_arn = aws_sns_topic.ses_bounces_topic.arn
  protocol  = "sqs"
  endpoint  = aws_sqs_queue.ses_bounces_queue.arn
}
</code></pre>
<ul>
<li>Set the ARN of the SNS topic to subscribe to <em>ses_bounces_topic</em>.</li>
<li>Set the protocol to <em>sqs</em> so that we can send the data to the SQS queue.</li>
<li>Set the endpoint to <em>ses_bounces_queue</em>.</li>
</ul>
<h2 id="step-4-configure-amazon-ses-to-publish-bounce-notifications-using-ses-bounces-topic-to-ses-bounces-queue">Step 4: Configure Amazon SES to publish bounce notifications using ses-bounces-topic to ses-bounces-queue</h2>
<p>I will use <a href="https://www.terraform.io/docs/providers/aws/r/ses_identity_notification_topic.html">Resource: ses_identity_notification_topic</a> to set the SNS topic to use when delivering bounce notifications.</p>
<pre><code class="language-hcl">resource "aws_ses_identity_notification_topic" "ses_bounces" {
  topic_arn                = aws_sns_topic.ses_bounces_topic.arn
  notification_type        = "Bounce"
  identity                 = email_domain
  include_original_headers = true
}
</code></pre>
<ul>
<li>Set the Amazon SNS topic to <em>ses_bounces_topic</em>.</li>
<li>Set the notification type to <em>Bounce</em>.</li>
<li>Set the identity to the email domain, e.g. setting to <em>example.com</em> will set it for emails in the <em>example.com</em> domain.</li>
<li>Include the original email headers in the SNS notifications.</li>
</ul>
<h2 id="step-5-ensure-that-iam-policies-are-in-place-so-that-amazon-sns-has-access-to-publish-to-the-appropriate-sqs-queues">Step 5: Ensure that IAM policies are in place so that Amazon SNS has access to publish to the appropriate SQS queues</h2>
<p>I will use <a href="https://www.terraform.io/docs/providers/aws/d/iam_policy_document.html">Data Source: aws_iam_policy_document</a> to configure the IAM policy to allow the SNS topic to send messages to the SQS queue and use <a href="https://www.terraform.io/docs/providers/aws/r/sqs_queue_policy.html">Resource: aws_sqs_queue_policy</a> to set the policy of the queue.</p>
<pre><code class="language-hcl">data "aws_iam_policy_document" "ses_bounces_queue_iam_policy" {
  policy_id = "SESBouncesQueueTopic"
  statement {
    sid       = "SESBouncesQueueTopic"
    effect    = "Allow"
    actions   = ["SQS:SendMessage"]
    resources = ["${aws_sqs_queue.ses_bounces_queue.arn}"]
    principals {
      identifiers = ["*"]
      type        = "*"
    }
    condition {
      test     = "ArnEquals"
      values   = ["${aws_sns_topic.ses_bounces_topic.arn}"]
      variable = "aws:SourceArn"
    }
  }
}

resource "aws_sqs_queue_policy" "ses_queue_policy" {
  queue_url = aws_sqs_queue.ses_bounces_queue.id
  policy    = data.aws_iam_policy_document.ses_bounces_queue_iam_policy.json
}
</code></pre>
<ul>
<li>Set an id for the policy document.</li>
<li>Allow the sending of a message to the <em>ses_bounces_queue</em> SQS queue.</li>
<li>Allow it on all principles. <em>We can probably lock it down to just AWS ARN's</em>.</li>
<li>Constrain the policy so that access is allowed only when the request originates from <em>ses_bounces_topic</em>.</li>
<li>Set the URL of the SQS queue to <em>ses_bounces_queue</em>.</li>
<li>Set the policy.</li>
</ul>
<h2 id="next-steps">Next Steps</h2>
<p>You can see the <a href="https://github.com/AnkurSheel/ses-bounces">code here</a>.</p>
<p>So far, we have configured AWS to publish bounce notifications to an SQS queue. In the next post(s), we will see how we can configure an AWS Lambda to process the messages in the queue and send a custom message to a Slack channel.</p>
<p>Read <a href="handle-bounces-aws-ses-terraform-2">Part2</a></p>
</body></html>



<aside class="hidden md:block">
        <div class="flex justify-center gap-x-5 ">
            <a class="bg-social-twitter social-button" href="https://twitter.com/intent/tweet?url=https://www.ankursheel.com/blog/handle-bounces-ses-terraform&text=In%20this%20post%2C%20I%20configure%20AWS%20to%20publish%20email%20bounce%20notifications%20to%20an%20SQS%20queue%20using%20terraform via @ankur_sheel" target="_blank" rel="noopener noreferrer">Tweet this Article</a>
            <a class="bg-social-linkedin social-button" href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.ankursheel.com/blog/handle-bounces-ses-terraform"target="_blank" rel="noopener noreferrer">Share on Linkedin</a>
        </div>
</aside>



        </article>
    </div>
</main>


<script src="/assets/js/blog.js"></script>
    <script data-goatcounter="https://ankursheel.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>



    <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="ankursheel" data-description="Support me on Buy me a coffee!" data-message="Did you learn something or find this summary interesting? Buy me a coffee" data-color="#40DCA5" data-position="Right" data-x_margin="18" data-y_margin="18"></script>


</body>
</html>
